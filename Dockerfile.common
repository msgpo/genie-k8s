FROM nvidia/cuda:10.2-runtime-ubi8

MAINTAINER Thingpedia Admins <thingpedia-admins@lists.stanford.edu>

USER root

# install basic tools
RUN dnf -y install make gettext unzip xz python2 gcc-c++ \
	git gcc gcc-c++ \
	python3 \
	python3-numpy \
	python3-scipy \
	python3-pip \
	python3-devel \
	&& pip3 install awscli \
	&& dnf clean all \
	&& rm -fr /root/.cache

# install genienlp
RUN git clone https://github.com/stanford-oval/genienlp /opt/genienlp && \
	pip3 install -e /opt/genienlp \
	&& rm -fr /root/.cache

# download word embeddings
RUN mkdir -p /usr/local/share/genienlp/embeddings
WORKDIR /usr/local/share/genienlp/embeddings
RUN curl -L https://oval.cs.stanford.edu/data/glove/embeddings.tar.xz | tar xJv
RUN genienlp cache-embeddings -d /usr/local/share/genienlp/embeddings --embeddings bert-base-uncased+base-base-multilingual-uncased && \
    chmod -R 0755 /usr/locale/share/genienlp/embeddings
ENV GENIENLP_EMBEDDINGS=/usr/local/share/genienlp/embeddings

# install nodejs 10.x and yarn
RUN dnf -y module enable nodejs:10 && \
	curl -sL https://dl.yarnpkg.com/rpm/yarn.repo | tee /etc/yum.repos.d/yarn.repo && \
	dnf -y install nodejs yarn && \
	dnf clean all

# download PPDB
RUN curl https://parmesan.stanford.edu/glove/ppdb-2.0-m-lexical.bin -o /usr/local/share/ppdb-2.0-m-lexical.bin && \
    chmod 755 /usr/local/share/ppdb-2.0-m-lexical.bin
COPY ppdb-2.0-l-lexical.bin /usr/local/share/ppdb-2.0-l-lexical.bin
ENV PPDB=/usr/local/share/ppdb-2.0-l-lexical.bin
